# name: test/sql/cudasp.test
# description: test cudasp extension
# group: [sql]

# Require statement will ensure this test is run with this extension loaded
require cudasp

# Test the multiply_compare table function with small dataset
statement ok
CREATE TABLE test_data(value DOUBLE, search_list DOUBLE[]);

statement ok
INSERT INTO test_data VALUES (5.0, [10.0, 20.0, 15.0]), (3.0, [5.0, 7.0, 9.0]);

query I
SELECT multiplied_value FROM multiply_compare((SELECT value, search_list FROM test_data));
----
10.0

# Test with large dataset to verify batching (20K rows, 2x the batch size)
statement ok
CREATE TABLE large_test AS
SELECT CAST(column0 AS DOUBLE) AS value, CAST(column1 AS DOUBLE[]) AS search_list
FROM repeat_row(5.0, [10.0, 20.0, 15.0], num_rows := 20000);

query I
SELECT COUNT(*) FROM multiply_compare((SELECT value, search_list FROM large_test));
----
20000

query I
SELECT DISTINCT multiplied_value FROM multiply_compare((SELECT value, search_list FROM large_test));
----
10.0

# Test with very large dataset to verify parallel execution (200K rows, 20x the batch size)
statement ok
CREATE TABLE very_large_test AS
SELECT CAST(column0 AS DOUBLE) AS value, CAST(column1 AS DOUBLE[]) AS search_list
FROM repeat_row(5.0, [10.0, 20.0, 15.0], num_rows := 200000);

query I
SELECT COUNT(*) FROM multiply_compare((SELECT value, search_list FROM very_large_test));
----
200000

query I
SELECT DISTINCT multiplied_value FROM multiply_compare((SELECT value, search_list FROM very_large_test));
----
10.0
